[gcode_macro M106]
gcode:
  {% set fan = 0 %}
  {% set value = 0 %}
  
  {% if params.P is defined %}
    {% set fan = params.P|int %}
  {% endif %}
  
  {% if params.S is defined %}
    {% set value = params.S|float %}
  {% else %}
    {% set value = 255 %}
  {% endif %}
  {% if value > 255 %}
    {% set value = 255 %}
  {% endif %}
  
  {% if fan == 0 %}
    SET_FAN_SPEED FAN=fan SPEED={(value / 255 )}
  {% endif %}
  {% if fan == 1 or fan == 3 %}
    SET_FAN_SPEED FAN=exhaust SPEED={(value / 255 )}
  {% endif %}

[gcode_macro M107]
gcode:
  {% set fan = 0 %}
  {% if params.P is defined %}
    {% set fan = params.P|int %}
  {% endif %}
  
  {% if fan == 0 %}
    SET_FAN_SPEED FAN=fan SPEED=0
  {% endif %}
  {% if fan == 1 or fan == 3 %}
    SET_FAN_SPEED FAN=exhaust SPEED=0
  {% endif %}

[gcode_macro RESTORE_E_CURRENT]
gcode:
  {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}
  M400
  SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
  G4 P2000

[gcode_macro WAIT_EXTRUSION_ALL_MATERIALS]
gcode:

[gcode_macro SET_PIN]
rename_existing: SET_PIN_BASE
gcode:
  {% if params.PIN != "fan2" %}
    SET_PIN_BASE PIN={params.PIN} VALUE={params.VALUE}
  {% endif %}
